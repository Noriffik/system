# Что изменилось

- больше не нужен атрибут `[Plugin]`, достаточно унаследоваться от базового класса
- порядок инициализации
  - конструкторы всех плагинов,
  - конструктор контекста (получает коллекцию плагинов)
  - плагинам дается экземпляр контекста, логгер, конфиг
  - инициализация плагинов (считать, что все остальные не инициализированы)
  - запуск плагинов (считать, что все остальные инициализированы)
    ...
  - остановка плагинов
- CORE
  - события - синхронные/асинхронные (определяет плагин) `SafeInvoke`
  - подписка на события вручную
  - изменилось API Context: `Context.Using`, `Context.Require`, `GetAllPlugins<T>`
  - API для работы с конфигами: Microsoft.Extensions.Configuration (хелперы: Microsoft.Extensions.Configuration.Binder)
  - конфиг перенесен в свойство плагина
  - настройки плагинов в разделе "plugins:<полное название класса плагина>"
  - метод FindMethodsByAttribute у базового класса плагинов для поиска методов, отмеченных атрибутом
  - NLog => Microsoft.Extensions.Logging + Serilog
  - MEF => Microsoft.Extensions.DependencyInjection, не нужна ссылка в каждой DLL
  - 
- Database 
  - теперь в виде плагина, 
  - работает на EF
  - не нужно делать все поля виртуальными, 
  - конфигурация через атрибут [DbModelBuilder], 
  - инициализируется на PluginInit
  - для миграций портирован ECM7.Migrator
- Таймеры
  - регистрация через атрибуты, можно указать любой интервал
- Сценарии
  - JScript => V8 (jint)
  - из скриптов можно возвращать данные (написать return ...)
  - runScript => host.scripts.scriptName(args)
  - executeMethod => host.api.methodName(args)
  - logInfo, logError => host.log.trace/debug/info/warn/error/fatal
  - EmitScriptEvent для генерации сценарных событий
  - emit для генерации сценарных событий из других сценариев
  - обработчики сценарных событий запускаются асинхронно
- Listener => WebServer
- веб-сервер - теперь Kestrel, используется часть инфраструктуры ASP.NET Core MVC 
- порт веб-сервера в настройке `port`
- асинхронная обработка запросов
- изменены параметры http api сценариев
- сценарные плагины в отдельных пакетах
- WEB UI
  - marionette v3
  - bootstrap 4 alpha
  - requirejs => systemjs (поддержка форматов модулей)
  - полифилл для промисов, совместимы с $
  - кэширование ресурсов (во время разработки отключать кэш в браузере)
  - параметр alias для js ресурсов
  - получение конфига приложения с сервера
  - заглушка стартовой страницы (модуль 'welcome' + настройка мэппинга в конфиге)
  - загрузчик шаблонов применяется автоматом для `.tpl`, то же самое с `.json`
  - больше не используется JSON2
  
Теперь по умолчанию приложение ожидает Ctrl+C для остановки. Чтобы останавливалось по нажатию ENTER, нужно передать при запуске параметр -enter.

  
  
## Правила
- должен быть README
- При добавлении сущностей выпускаем новую минорную версию плагина, при изменении/удалении сущностей - мажорную версию
- При выпуске мажорной версии плагина нужно слить миграции последней мажорной версии в одну (с последним номером)??

## README

*название пакета* 

[![NuGet Pre Release](https://img.shields.io/nuget/vpre/ThinkingHome.Plugins.XXX.svg)]()

\# Название плагина

- плагины
  - описание + UI
  - .NET API (methods + events)
  - script API (methods + events)
  - HTTP API и ресурсы
  - параметры конфига
